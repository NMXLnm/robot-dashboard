<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>论坛</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: Inter, ui-sans-serif, system-ui;
      background:#0f172a;
      color:#fff;
    }

    /* 背景 */
    .bg-wrap{position:fixed;inset:0;z-index:-1;overflow:hidden;}
    .blob{position:absolute;width:70vmax;height:70vmax;top:50%;left:50%;border-radius:50%;
      filter:blur(60px) saturate(160%);mix-blend-mode:screen;animation:float 15s infinite alternate;}
    .b1{background:radial-gradient(circle,rgba(255,120,200,.9),rgba(80,180,255,.3));}
    .b2{background:radial-gradient(circle,rgba(0,240,255,.9),rgba(200,80,255,.3));animation-duration:18s;}
    .b3{background:radial-gradient(circle,rgba(255,200,90,.9),rgba(255,120,120,.4));animation-duration:20s;}
    @keyframes float{from{transform:translate(-50%,-50%) scale(1);}to{transform:translate(-45%,-55%) scale(1.2);}}
    .noise{pointer-events:none;position:fixed;inset:0;opacity:0.05;mix-blend-mode:overlay;}

    header{padding:20px;text-align:center;font-size:1.8em;font-weight:bold;background:rgba(0,0,0,.3);}
    header a{font-size:.6em;margin-left:15px;color:#0ff;text-decoration:none;}
    main{padding:20px;}

    .card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);
      border-radius:16px;padding:15px;margin-bottom:20px;backdrop-filter:blur(12px) saturate(150%);
      box-shadow:0 10px 30px rgba(2,6,23,.6);}
    .card h3{margin-bottom:6px;}
    .meta{font-size:.8em;color:#ccc;margin-bottom:8px;}
    .tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.8em;
      background:linear-gradient(90deg,#4facfe,#00f2fe);color:#fff;}

    #posts button{margin:3px;}
    #auth,#newPost{text-align:center;margin:20px;}
    input,textarea,select{width:90%;max-width:400px;margin:6px auto;padding:8px;border-radius:8px;border:none;}
    button{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
    .btn-small{font-size:.8em;padding:3px 8px;}

    .replies{margin-left:15px;margin-top:10px;border-left:2px solid rgba(255,255,255,.2);padding-left:10px;}
  </style>
</head>
<body>
  <div class="bg-wrap">
    <div class="blob b1"></div><div class="blob b2"></div><div class="blob b3"></div>
    <div class="noise"></div>
  </div>

  <header>💬 论坛 <a href="index.html">回管理面板</a></header>

  <main>
    <div id="auth">
      <input id="email" placeholder="邮箱">
      <input id="password" type="password" placeholder="密码">
      <button onclick="register()">注册</button>
      <button onclick="login()">登录</button>
      <button onclick="logout()">登出</button>
      <input type="file" id="avatarUpload" accept="image/*">
    </div>

    <!-- 分类筛选 -->
    <div style="text-align:center;margin:10px;">
      <button onclick="filterCategory('全部')">全部</button>
      <button onclick="filterCategory('聊天')">聊天</button>
      <button onclick="filterCategory('技术')">技术</button>
      <button onclick="filterCategory('反馈')">反馈</button>
    </div>

    <!-- 发布新帖 -->
    <div id="newPost" style="display:none;">
      <input id="postTitle" placeholder="帖子标题"><br>
      <textarea id="postContent" placeholder="帖子内容"></textarea><br>
      <select id="postCategory">
        <option value="聊天">聊天</option>
        <option value="技术">技术</option>
        <option value="反馈">反馈</option>
      </select><br>
      <button onclick="addPost()">发布</button>
      <button onclick="cancelNewPost()">取消</button>
    </div>
    <div style="text-align:center;"><button onclick="showNewPost()">✏ 发布帖子</button></div>

    <!-- 帖子区 -->
    <div id="posts"></div>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore,collection,addDoc,getDocs,serverTimestamp,query,orderBy,deleteDoc,doc,updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage,ref,uploadBytes,getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig={
      apiKey:"AIzaSyD7KN-D2L52ckATbk1aEDZgwhXYDADU7sE",
      authDomain:"fir-9fe3e.firebaseapp.com",
      projectId:"fir-9fe3e",
      storageBucket:"fir-9fe3e.appspot.com",
      messagingSenderId:"110235897961",
      appId:"1:110235897961:web:aa862e3d76ec5879c252f8"
    };
    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);
    const storage=getStorage(app);

    const postsContainer=document.getElementById("posts");
    let currentCategory="全部";

    // 注册
    async function register(){
      const email=document.getElementById("email").value;
      const pw=document.getElementById("password").value;
      await createUserWithEmailAndPassword(auth,email,pw);
      alert("注册成功");
    }
    // 登录
    async function login(){
      const email=document.getElementById("email").value;
      const pw=document.getElementById("password").value;
      await signInWithEmailAndPassword(auth,email,pw);
      alert("登录成功");
    }
    function logout(){signOut(auth);}

    // 上传头像
    document.getElementById("avatarUpload").addEventListener("change",async e=>{
      const file=e.target.files[0];
      if(!file||!auth.currentUser)return;
      const r=ref(storage,"avatars/"+auth.currentUser.uid);
      await uploadBytes(r,file);
      const url=await getDownloadURL(r);
      await updateProfile(auth.currentUser,{photoURL:url});
      alert("头像已更新");
    });

    function showNewPost(){document.getElementById("newPost").style.display="block";}
    function cancelNewPost(){document.getElementById("newPost").style.display="none";}

    // 发帖
    async function addPost(){
      const title=document.getElementById("postTitle").value.trim();
      const content=document.getElementById("postContent").value.trim();
      const category=document.getElementById("postCategory").value;
      if(!title||!content) return alert("请填写完整！");
      await addDoc(collection(db,"posts"),{
        title,content,category,
        author:auth.currentUser?auth.currentUser.email:"匿名",
        avatar:auth.currentUser?.photoURL||"",
        time:serverTimestamp(),
        pinned:false
      });
      cancelNewPost();
      loadPosts();
    }

    function filterCategory(cat){currentCategory=cat;loadPosts();}

    // 加载帖子
    async function loadPosts(){
      postsContainer.innerHTML="";
      const q=query(collection(db,"posts"),orderBy("time","desc"));
      const snapshot=await getDocs(q);
      let pinned=[],normal=[];
      snapshot.forEach(d=>{
        const p={id:d.id,...d.data()};
        if(currentCategory!=="全部" && p.category!==currentCategory) return;
        if(p.pinned)pinned.push(p);else normal.push(p);
      });
      [...pinned,...normal].forEach(p=>{
        const div=document.createElement("div");div.className="card";
        div.innerHTML=`
          <h3>${p.title} ${p.pinned?"📌":""}</h3>
          <div class="meta">分类: <span class="tag">${p.category}</span> | 作者: ${p.author} | ${p.time? p.time.toDate().toLocaleString():""}</div>
          ${p.avatar?`<img src="${p.avatar}" width="40" style="border-radius:50%">`:""}
          <p>${p.content}</p>
          <div class="replies" id="replies-${p.id}"></div>
          <input id="reply-${p.id}" placeholder="回复内容">
          <button class="btn-small" onclick="replyPost('${p.id}')">回复</button>
          ${isAdmin(auth.currentUser)?`
            <button class="btn-small" onclick="deletePost('${p.id}')">🗑 删除</button>
            <button class="btn-small" onclick="togglePin('${p.id}',${p.pinned})">${p.pinned?"取消置顶":"📌 置顶"}</button>
          `:""}
        `;
        postsContainer.appendChild(div);
        loadReplies(p.id);
      });
    }

    // 回复
    async function replyPost(id){
      const c=document.getElementById("reply-"+id).value.trim();
      if(!c) return;
      await addDoc(collection(db,"posts",id,"replies"),{
        content:c,
        author:auth.currentUser?auth.currentUser.email:"匿名",
        time:serverTimestamp()
      });
      loadReplies(id);
    }
    async function loadReplies(id){
      const cont=document.getElementById("replies-"+id);
      cont.innerHTML="";
      const q=query(collection(db,"posts",id,"replies"),orderBy("time","asc"));
      const snap=await getDocs(q);
      snap.forEach(r=>{
        const d=r.data();
        cont.innerHTML+=`<p><b>${d.author}:</b> ${d.content}</p>`;
      });
    }

    // 管理员功能
    function isAdmin(u){return u&&u.email==="admin@example.com";}
    async function deletePost(id){await deleteDoc(doc(db,"posts",id));loadPosts();}
    async function togglePin(id,st){await updateDoc(doc(db,"posts",id),{pinned:!st});loadPosts();}

    auth.onAuthStateChanged(()=>loadPosts());
  </script>
</body>
</html>
